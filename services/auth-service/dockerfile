FROM node:20-slim

# Keep repo-like structure so relative imports work both in dev and prod
WORKDIR /app/services/auth-service

# System deps for native modules (bcrypt) and sqlite3
RUN apt-get update && apt-get install -y \
    python3 \
    make \
    g++ \
    sqlite3 \
    libsqlite3-dev \
    && rm -rf /var/lib/apt/lists/*

# Install dependencies first (faster builds via layer caching)
COPY services/auth-service/package*.json ./
RUN npm ci --no-audit --no-fund

# Copy service source and shared DB module
COPY services/auth-service/ ./
COPY Shared_dataBase/ /app/Shared_dataBase/

# Ensure database mount path exists
RUN mkdir -p /app/database && chmod 755 /app/database

# Build TypeScript -> dist
RUN npm run build

# Ensure bcrypt native binding matches the container OS/CPU
RUN npm rebuild bcrypt --build-from-source

EXPOSE 3010

CMD ["node", "dist/server.js"]FROM node:20-slim

# Use service directory as workdir so relative imports remain correct after build
WORKDIR /app/services/auth-service

RUN apt-get update && apt-get install -y \
    curl \
    python3 \
    make \
    g++ \
    sqlite3 \
    libsqlite3-dev \
    && rm -rf /var/lib/apt/lists/*

# Install service dependencies (dev deps included for TypeScript build)
COPY services/auth-service/package*.json ./
RUN npm install

# Copy service source and the shared DB module (kept in JS)
COPY services/auth-service/ ./
COPY Shared_dataBase/ /app/Shared_dataBase/

# Ensure database volume mount path exists at /app/database
RUN mkdir -p /app/database && chmod 755 /app/database

# Build TypeScript -> dist
RUN npm run build

# Rebuild bcrypt native binding inside the container to avoid ELF mismatch
RUN npm rebuild bcrypt --build-from-source

EXPOSE 3010

# HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
#   CMD curl -f http://localhost:3010/test || exit 1

CMD ["node", "dist/server.js"]
FROM node:20-slim

# Keep the same folder structure as the repo so relative imports work
WORKDIR /app/services/auth-service

RUN apt-get update && apt-get install -y \
    curl \
    python3 \
    make \
    g++ \
    sqlite3 \
    libsqlite3-dev \
    && rm -rf /var/lib/apt/lists/*

# Install service dependencies
COPY services/auth-service/package*.json ./
RUN npm install

# Copy service source and the shared DB module
COPY services/auth-service/ ./
COPY Shared_dataBase/ /app/Shared_dataBase/

# Ensure database volume mount path exists at /app/database
RUN mkdir -p /app/database && chmod 755 /app/database

# Build TypeScript -> dist
RUN npm run build

EXPOSE 3010

# HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
#   CMD curl -f http://localhost:3010/test || exit 1

CMD ["node", "dist/server.js"]FROM node:20-slim

WORKDIR /app

RUN apt-get update && apt-get install -y \
    curl \
    python3 \
    make \
    g++ \
    sqlite3 \
    libsqlite3-dev \
    && rm -rf /var/lib/apt/lists/*

# Install dependencies
COPY services/auth-service/package*.json ./
RUN npm install

# Copy source code
COPY services/auth-service/ ./
COPY Shared_dataBase/ ./Shared_dataBase/

# Ensure database folder exists and is writable; it will be mounted in compose
RUN mkdir -p database && chmod 755 database

# Build TypeScript -> dist
RUN npm run build

EXPOSE 3010

# HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
#   CMD curl -f http://localhost:3010/test || exit 1

CMD ["node", "dist/server.js"]